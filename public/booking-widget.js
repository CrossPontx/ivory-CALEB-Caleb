/**
 * Ivory Choice Booking Widget
 * Embeddable booking system for nail tech websites generated by V0
 * 
 * Usage:
 * <script src="https://ivoryschoice.com/booking-widget.js"></script>
 * <div id="ivory-booking-widget" data-tech-id="123"></div>
 * <script>IvoryBooking.init();</script>
 */

(function() {
  'use strict';

  const API_BASE = 'https://ivoryschoice.com/api/public';
  
  const IvoryBooking = {
    widgets: new Map(),
    
    init: function() {
      const widgets = document.querySelectorAll('[id^="ivory-booking-widget"]');
      widgets.forEach(widget => this.initWidget(widget));
    },
    
    initWidget: function(container) {
      const techId = container.dataset.techId;
      if (!techId) {
        console.error('Ivory Booking Widget: data-tech-id is required');
        return;
      }
      
      const widgetId = `widget-${techId}-${Date.now()}`;
      this.widgets.set(widgetId, {
        container,
        techId,
        currentStep: 'loading',
        selectedService: null,
        selectedDateTime: null,
        techData: null,
        availability: null
      });
      
      this.loadTechData(widgetId);
    },
    
    async loadTechData(widgetId) {
      const widget = this.widgets.get(widgetId);
      
      try {
        // Load tech profile and services
        const techResponse = await fetch(`${API_BASE}/tech/${widget.techId}`);
        if (!techResponse.ok) throw new Error('Failed to load tech profile');
        const techData = await techResponse.json();
        
        // Load availability
        const availabilityResponse = await fetch(`${API_BASE}/tech/${widget.techId}/availability?days=14`);
        if (!availabilityResponse.ok) throw new Error('Failed to load availability');
        const availabilityData = await availabilityResponse.json();
        
        widget.techData = techData.tech;
        widget.availability = availabilityData;
        widget.currentStep = 'services';
        
        this.renderWidget(widgetId);
      } catch (error) {
        console.error('Ivory Booking Widget Error:', error);
        this.renderError(widgetId, 'Failed to load booking information');
      }
    },
    
    renderWidget: function(widgetId) {
      const widget = this.widgets.get(widgetId);
      const { container, currentStep, techData } = widget;
      
      let html = '';
      
      // Widget styles
      const styles = `
        <style>
          .ivory-widget {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 500px;
            margin: 0 auto;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
          }
          .ivory-header {
            background: linear-gradient(135deg, #8B7355 0%, #6B5B47 100%);
            color: white;
            padding: 20px;
            text-align: center;
          }
          .ivory-header h3 {
            margin: 0 0 8px 0;
            font-size: 20px;
            font-weight: 600;
          }
          .ivory-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
          }
          .ivory-content {
            padding: 24px;
          }
          .ivory-service {
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
          }
          .ivory-service:hover {
            border-color: #8B7355;
            background: #fafafa;
          }
          .ivory-service.selected {
            border-color: #8B7355;
            background: #f8f6f3;
          }
          .ivory-service h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: #1a1a1a;
          }
          .ivory-service p {
            margin: 0 0 8px 0;
            color: #666;
            font-size: 14px;
          }
          .ivory-service .price {
            font-weight: 600;
            color: #8B7355;
          }
          .ivory-time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 16px;
          }
          .ivory-time-slot {
            padding: 8px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
          }
          .ivory-time-slot:hover {
            border-color: #8B7355;
            background: #fafafa;
          }
          .ivory-time-slot.selected {
            background: #8B7355;
            color: white;
            border-color: #8B7355;
          }
          .ivory-form {
            margin-top: 20px;
          }
          .ivory-form-group {
            margin-bottom: 16px;
          }
          .ivory-form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #1a1a1a;
          }
          .ivory-form-group input,
          .ivory-form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
          }
          .ivory-form-group input:focus,
          .ivory-form-group textarea:focus {
            outline: none;
            border-color: #8B7355;
          }
          .ivory-button {
            background: #8B7355;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
          }
          .ivory-button:hover {
            background: #6B5B47;
          }
          .ivory-button:disabled {
            background: #ccc;
            cursor: not-allowed;
          }
          .ivory-back-button {
            background: transparent;
            color: #8B7355;
            border: 1px solid #8B7355;
            margin-right: 12px;
            width: auto;
            flex: 1;
          }
          .ivory-button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
          }
          .ivory-summary {
            background: #f8f6f3;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
          }
          .ivory-summary h4 {
            margin: 0 0 12px 0;
            color: #1a1a1a;
          }
          .ivory-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
          }
          .ivory-error {
            color: #dc2626;
            background: #fef2f2;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
          }
          .ivory-success {
            color: #059669;
            background: #f0fdf4;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
          }
        </style>
      `;
      
      if (currentStep === 'loading') {
        html = styles + `
          <div class="ivory-widget">
            <div class="ivory-header">
              <h3>Loading...</h3>
              <p>Please wait while we load booking information</p>
            </div>
          </div>
        `;
      } else if (currentStep === 'services') {
        html = styles + `
          <div class="ivory-widget">
            <div class="ivory-header">
              <h3>Book with ${techData.businessName}</h3>
              <p>${techData.location}</p>
            </div>
            <div class="ivory-content">
              <h4 style="margin-top: 0;">Select a Service</h4>
              ${techData.services.map(service => `
                <div class="ivory-service" onclick="IvoryBooking.selectService('${widgetId}', ${service.id})">
                  <h4>${service.name}</h4>
                  <p>${service.description || ''}</p>
                  <div class="price">$${service.price} • ${service.duration} min</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      } else if (currentStep === 'datetime') {
        const availableSlots = widget.availability.timeSlots || [];
        const groupedSlots = this.groupSlotsByDate(availableSlots);
        
        html = styles + `
          <div class="ivory-widget">
            <div class="ivory-header">
              <h3>Select Date & Time</h3>
              <p>${widget.selectedService.name} • $${widget.selectedService.price}</p>
            </div>
            <div class="ivory-content">
              ${Object.keys(groupedSlots).length === 0 ? 
                '<p>No available time slots found. Please contact the nail tech directly.</p>' :
                Object.entries(groupedSlots).map(([date, slots]) => `
                  <div style="margin-bottom: 24px;">
                    <h4>${this.formatDate(date)}</h4>
                    <div class="ivory-time-slots">
                      ${slots.map(slot => `
                        <div class="ivory-time-slot" onclick="IvoryBooking.selectDateTime('${widgetId}', '${slot.datetime}')">
                          ${slot.time}
                        </div>
                      `).join('')}
                    </div>
                  </div>
                `).join('')
              }
              <div class="ivory-button-group">
                <button class="ivory-button ivory-back-button" onclick="IvoryBooking.goBack('${widgetId}')">
                  Back
                </button>
                <button class="ivory-button" onclick="IvoryBooking.nextStep('${widgetId}')" disabled>
                  Continue
                </button>
              </div>
            </div>
          </div>
        `;
      } else if (currentStep === 'details') {
        const selectedDateTime = new Date(widget.selectedDateTime);
        html = styles + `
          <div class="ivory-widget">
            <div class="ivory-header">
              <h3>Your Information</h3>
              <p>Almost done!</p>
            </div>
            <div class="ivory-content">
              <div class="ivory-summary">
                <h4>Booking Summary</h4>
                <div class="ivory-summary-item">
                  <span>Service:</span>
                  <span>${widget.selectedService.name}</span>
                </div>
                <div class="ivory-summary-item">
                  <span>Date:</span>
                  <span>${selectedDateTime.toLocaleDateString()}</span>
                </div>
                <div class="ivory-summary-item">
                  <span>Time:</span>
                  <span>${selectedDateTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                </div>
                <div class="ivory-summary-item">
                  <span>Price:</span>
                  <span>$${widget.selectedService.price}</span>
                </div>
              </div>
              
              <form class="ivory-form" onsubmit="IvoryBooking.submitBooking('${widgetId}', event)">
                <div class="ivory-form-group">
                  <label for="name-${widgetId}">Full Name *</label>
                  <input type="text" id="name-${widgetId}" name="name" required>
                </div>
                <div class="ivory-form-group">
                  <label for="email-${widgetId}">Email Address *</label>
                  <input type="email" id="email-${widgetId}" name="email" required>
                </div>
                <div class="ivory-form-group">
                  <label for="phone-${widgetId}">Phone Number</label>
                  <input type="tel" id="phone-${widgetId}" name="phone">
                </div>
                <div class="ivory-form-group">
                  <label for="notes-${widgetId}">Special Requests (Optional)</label>
                  <textarea id="notes-${widgetId}" name="notes" rows="3" placeholder="Any special requests or notes for your nail tech..."></textarea>
                </div>
                
                <div class="ivory-button-group">
                  <button type="button" class="ivory-button ivory-back-button" onclick="IvoryBooking.goBack('${widgetId}')">
                    Back
                  </button>
                  <button type="submit" class="ivory-button">
                    Book Appointment
                  </button>
                </div>
              </form>
            </div>
          </div>
        `;
      } else if (currentStep === 'success') {
        html = styles + `
          <div class="ivory-widget">
            <div class="ivory-header">
              <h3>Booking Confirmed!</h3>
              <p>We'll be in touch soon</p>
            </div>
            <div class="ivory-content">
              <div class="ivory-success">
                Your booking request has been sent to ${techData.businessName}. They will contact you shortly to confirm your appointment and arrange payment.
              </div>
              <p><strong>What's next?</strong></p>
              <ul style="margin: 16px 0; padding-left: 20px;">
                <li>You'll receive a confirmation email</li>
                <li>${techData.businessName} will contact you within 24 hours</li>
                <li>Payment will be processed when you arrive</li>
              </ul>
              <button class="ivory-button" onclick="IvoryBooking.reset('${widgetId}')">
                Book Another Appointment
              </button>
            </div>
          </div>
        `;
      }
      
      container.innerHTML = html;
    },
    
    renderError: function(widgetId, message) {
      const widget = this.widgets.get(widgetId);
      const styles = `<style>.ivory-widget { font-family: sans-serif; max-width: 500px; margin: 0 auto; padding: 20px; border: 1px solid #e5e5e5; border-radius: 8px; } .ivory-error { color: #dc2626; background: #fef2f2; padding: 12px; border-radius: 6px; }</style>`;
      widget.container.innerHTML = styles + `
        <div class="ivory-widget">
          <div class="ivory-error">
            ${message}
          </div>
        </div>
      `;
    },
    
    selectService: function(widgetId, serviceId) {
      const widget = this.widgets.get(widgetId);
      widget.selectedService = widget.techData.services.find(s => s.id === serviceId);
      widget.currentStep = 'datetime';
      this.renderWidget(widgetId);
    },
    
    selectDateTime: function(widgetId, datetime) {
      const widget = this.widgets.get(widgetId);
      widget.selectedDateTime = datetime;
      
      // Update UI to show selection
      const slots = widget.container.querySelectorAll('.ivory-time-slot');
      slots.forEach(slot => slot.classList.remove('selected'));
      event.target.classList.add('selected');
      
      // Enable continue button
      const continueBtn = widget.container.querySelector('.ivory-button:not(.ivory-back-button)');
      continueBtn.disabled = false;
    },
    
    nextStep: function(widgetId) {
      const widget = this.widgets.get(widgetId);
      if (widget.currentStep === 'datetime' && widget.selectedDateTime) {
        widget.currentStep = 'details';
        this.renderWidget(widgetId);
      }
    },
    
    goBack: function(widgetId) {
      const widget = this.widgets.get(widgetId);
      if (widget.currentStep === 'datetime') {
        widget.currentStep = 'services';
        widget.selectedService = null;
      } else if (widget.currentStep === 'details') {
        widget.currentStep = 'datetime';
        widget.selectedDateTime = null;
      }
      this.renderWidget(widgetId);
    },
    
    async submitBooking(widgetId, event) {
      event.preventDefault();
      const widget = this.widgets.get(widgetId);
      const form = event.target;
      const formData = new FormData(form);
      
      const bookingData = {
        techProfileId: parseInt(widget.techId),
        serviceId: widget.selectedService.id,
        appointmentDate: widget.selectedDateTime,
        clientName: formData.get('name'),
        clientEmail: formData.get('email'),
        clientPhone: formData.get('phone'),
        clientNotes: formData.get('notes')
      };
      
      try {
        // Disable submit button
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Booking...';
        
        const response = await fetch(`${API_BASE}/bookings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(bookingData)
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to create booking');
        }
        
        const result = await response.json();
        widget.bookingResult = result.booking;
        widget.currentStep = 'success';
        this.renderWidget(widgetId);
        
      } catch (error) {
        console.error('Booking error:', error);
        
        // Show error message
        const existingError = form.querySelector('.ivory-error');
        if (existingError) existingError.remove();
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'ivory-error';
        errorDiv.textContent = error.message;
        form.insertBefore(errorDiv, form.firstChild);
        
        // Re-enable submit button
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Book Appointment';
      }
    },
    
    reset: function(widgetId) {
      const widget = this.widgets.get(widgetId);
      widget.currentStep = 'services';
      widget.selectedService = null;
      widget.selectedDateTime = null;
      widget.bookingResult = null;
      this.renderWidget(widgetId);
    },
    
    groupSlotsByDate: function(slots) {
      const grouped = {};
      slots.forEach(slot => {
        if (!grouped[slot.date]) {
          grouped[slot.date] = [];
        }
        grouped[slot.date].push(slot);
      });
      return grouped;
    },
    
    formatDate: function(dateStr) {
      const date = new Date(dateStr);
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(today.getDate() + 1);
      
      if (date.toDateString() === today.toDateString()) {
        return 'Today';
      } else if (date.toDateString() === tomorrow.toDateString()) {
        return 'Tomorrow';
      } else {
        return date.toLocaleDateString('en-US', { 
          weekday: 'long', 
          month: 'short', 
          day: 'numeric' 
        });
      }
    }
  };
  
  // Make IvoryBooking globally available
  window.IvoryBooking = IvoryBooking;
  
  // Auto-initialize if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => IvoryBooking.init());
  } else {
    IvoryBooking.init();
  }
})();